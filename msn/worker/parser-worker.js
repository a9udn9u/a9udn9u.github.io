function isEmpty(t){return null==t||0==t.length}function __unescapeString(t){return t=t.replace(/&amp;/g,"&"),t=t.replace(/&lt;/g,"<"),t=t.replace(/&gt;/g,">"),t=t.replace(/&quot;/g,'"'),t=t.replace(/&apos;/g,"'")}function SAXEventHandler(t){var e=this;this.characterData="",this.currentMessage,this.currentUserType,this.currentText,this.firstUser,this.lastSession=-1,this.chatLogs=[],this.sendBatch=function(t){var r=e.chatLogs.map(function(t){var r="",i=t.from===e.firstUser;return e.lastSession!==t.session&&(r='<div class="hr"><span>'+t.time+"</span></div>",e.lastSession=t.session),"\n\t\t\t\t"+r+'\n\t\t\t\t<div class="message '+(i?"left":"right")+'">\n\t\t\t\t\t<div class="bubble">'+t.text+'</div>\n\t\t\t\t\t<div class="user" data-balloon="'+t.time+'" data-balloon-pos="'+(i?"right":"left")+'">'+t.from+"</div>\n\t\t\t\t</div>\n\t\t\t"});self.postMessage({html:r.join("\n"),lastBatch:!t}),e.chatLogs=[]},this.fatalError=function(t){self.postMessage({html:"Invalid XML",lastBatch:!0})},this.characters=function(t,r,i){e.characterData+=t.substr(r,i)},this._handleCharacterData=function(){""!==e.characterData&&e._fullCharacterDataReceived(e.characterData),e.characterData=""},this._fullCharacterDataReceived=function(t){e.currentText&&e.currentText.push(t)},this.endDocument=this.sendBatch,this.endElement=function(r){e._handleCharacterData(),"Message"===r&&(e.chatLogs.push(e.currentMessage),e.currentMessage=void 0,e.chatLogs.length%t==0&&e.sendBatch(!0)),"Text"===r&&e.currentMessage&&(e.currentMessage.text=e.currentText.join("<br>"),e.currentText=void 0)},this.startElement=function(t,r){if("Message"===t&&(e.currentMessage={time:new Date(r.getValueByName("DateTime")),session:r.getValueByName("SessionID")}),"From"!==t&&"To"!==t||(e.currentUserType=t.toLowerCase()),"User"===t&&e.currentMessage){var i=r.getValueByName("FriendlyName");e.currentMessage[e.currentUserType]=i,e.firstUser||(e.firstUser=i)}"Text"===t&&(e.currentText=[]),e._handleCharacterData()}}var whitespace="\n\r\t ";XMLP=function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){t=SAXStrings.replace(t,null,null,"\r\n","\n"),t=SAXStrings.replace(t,null,null,"\r","\n"),this.m_xml=t,this.m_iP=0,this.m_iState=XMLP._STATE_PROLOG,this.m_stack=new Stack,this._clearAttributes()}),XMLP._NONE=0,XMLP._ELM_B=1,XMLP._ELM_E=2,XMLP._ELM_EMP=3,XMLP._ATT=4,XMLP._TEXT=5,XMLP._ENTITY=6,XMLP._PI=7,XMLP._CDATA=8,XMLP._COMMENT=9,XMLP._DTD=10,XMLP._ERROR=11,XMLP._CONT_XML=0,XMLP._CONT_ALT=1,XMLP._ATT_NAME=0,XMLP._ATT_VAL=1,XMLP._STATE_PROLOG=1,XMLP._STATE_DOCUMENT=2,XMLP._STATE_MISC=3,XMLP._errs=new Array,XMLP._errs[XMLP.ERR_CLOSE_PI=0]="PI: missing closing sequence",XMLP._errs[XMLP.ERR_CLOSE_DTD=1]="DTD: missing closing sequence",XMLP._errs[XMLP.ERR_CLOSE_COMMENT=2]="Comment: missing closing sequence",XMLP._errs[XMLP.ERR_CLOSE_CDATA=3]="CDATA: missing closing sequence",XMLP._errs[XMLP.ERR_CLOSE_ELM=4]="Element: missing closing sequence",XMLP._errs[XMLP.ERR_CLOSE_ENTITY=5]="Entity: missing closing sequence",XMLP._errs[XMLP.ERR_PI_TARGET=6]="PI: target is required",XMLP._errs[XMLP.ERR_ELM_EMPTY=7]="Element: cannot be both empty and closing",XMLP._errs[XMLP.ERR_ELM_NAME=8]='Element: name must immediatly follow "<"',XMLP._errs[XMLP.ERR_ELM_LT_NAME=9]='Element: "<" not allowed in element names',XMLP._errs[XMLP.ERR_ATT_VALUES=10]="Attribute: values are required and must be in quotes",XMLP._errs[XMLP.ERR_ATT_LT_NAME=11]='Element: "<" not allowed in attribute names',XMLP._errs[XMLP.ERR_ATT_LT_VALUE=12]='Attribute: "<" not allowed in attribute values',XMLP._errs[XMLP.ERR_ATT_DUP=13]="Attribute: duplicate attributes not allowed",XMLP._errs[XMLP.ERR_ENTITY_UNKNOWN=14]="Entity: unknown entity",XMLP._errs[XMLP.ERR_INFINITELOOP=15]="Infininte loop",XMLP._errs[XMLP.ERR_DOC_STRUCTURE=16]="Document: only comments, processing instructions, or whitespace allowed outside of document element",XMLP._errs[XMLP.ERR_ELM_NESTING=17]="Element: must be nested correctly",XMLP.prototype._addAttribute=function(t,e){this.m_atts[this.m_atts.length]=new Array(t,e)},XMLP.prototype._checkStructure=function(t){if(XMLP._STATE_PROLOG==this.m_iState){if((XMLP._TEXT==t||XMLP._ENTITY==t)&&SAXStrings.indexOfNonWhitespace(this.getContent(),this.getContentBegin(),this.getContentEnd())!=-1)return this._setErr(XMLP.ERR_DOC_STRUCTURE);XMLP._ELM_B!=t&&XMLP._ELM_EMP!=t||(this.m_iState=XMLP._STATE_DOCUMENT)}if(XMLP._STATE_DOCUMENT==this.m_iState){if(XMLP._ELM_B!=t&&XMLP._ELM_EMP!=t||this.m_stack.push(this.getName()),XMLP._ELM_E==t||XMLP._ELM_EMP==t){var e=this.m_stack.pop();if(null==e||e!=this.getName())return this._setErr(XMLP.ERR_ELM_NESTING)}if(0==this.m_stack.count())return this.m_iState=XMLP._STATE_MISC,t}if(XMLP._STATE_MISC==this.m_iState){if(XMLP._ELM_B==t||XMLP._ELM_E==t||XMLP._ELM_EMP==t||XMLP.EVT_DTD==t)return this._setErr(XMLP.ERR_DOC_STRUCTURE);if((XMLP._TEXT==t||XMLP._ENTITY==t)&&SAXStrings.indexOfNonWhitespace(this.getContent(),this.getContentBegin(),this.getContentEnd())!=-1)return this._setErr(XMLP.ERR_DOC_STRUCTURE)}return t},XMLP.prototype._clearAttributes=function(){this.m_atts=new Array},XMLP.prototype._findAttributeIndex=function(t){for(var e=0;e<this.m_atts.length;e++)if(this.m_atts[e][XMLP._ATT_NAME]==t)return e;return-1},XMLP.prototype.getAttributeCount=function(){return this.m_atts?this.m_atts.length:0},XMLP.prototype.getAttributeName=function(t){return t<0||t>=this.m_atts.length?null:this.m_atts[t][XMLP._ATT_NAME]},XMLP.prototype.getAttributeValue=function(t){return t<0||t>=this.m_atts.length?null:__unescapeString(this.m_atts[t][XMLP._ATT_VAL])},XMLP.prototype.getAttributeValueByName=function(t){return this.getAttributeValue(this._findAttributeIndex(t))},XMLP.prototype.getColumnNumber=function(){return SAXStrings.getColumnNumber(this.m_xml,this.m_iP)},XMLP.prototype.getContent=function(){return this.m_cSrc==XMLP._CONT_XML?this.m_xml:this.m_cAlt},XMLP.prototype.getContentBegin=function(){return this.m_cB},XMLP.prototype.getContentEnd=function(){return this.m_cE},XMLP.prototype.getLineNumber=function(){return SAXStrings.getLineNumber(this.m_xml,this.m_iP)},XMLP.prototype.getName=function(){return this.m_name},XMLP.prototype.next=function(){return this._checkStructure(this._parse())},XMLP.prototype._parse=function(){return this.m_iP==this.m_xml.length?XMLP._NONE:this.m_iP==this.m_xml.indexOf("<?",this.m_iP)?this._parsePI(this.m_iP+2):this.m_iP==this.m_xml.indexOf("<!DOCTYPE",this.m_iP)?this._parseDTD(this.m_iP+9):this.m_iP==this.m_xml.indexOf("<!--",this.m_iP)?this._parseComment(this.m_iP+4):this.m_iP==this.m_xml.indexOf("<![CDATA[",this.m_iP)?this._parseCDATA(this.m_iP+9):this.m_iP==this.m_xml.indexOf("<",this.m_iP)?this._parseElement(this.m_iP+1):this.m_iP==this.m_xml.indexOf("&",this.m_iP)?this._parseEntity(this.m_iP+1):this._parseText(this.m_iP)},XMLP.prototype._parseAttribute=function(t,e){var r,i,n,s,_,h,o,a;return this.m_cAlt="",(r=SAXStrings.indexOfNonWhitespace(this.m_xml,t,e))==-1||r>=e?r:(n=this.m_xml.indexOf("=",r))==-1||n>e?this._setErr(XMLP.ERR_ATT_VALUES):(i=SAXStrings.lastIndexOfNonWhitespace(this.m_xml,r,n),(s=SAXStrings.indexOfNonWhitespace(this.m_xml,n+1,e))==-1||s>e?this._setErr(XMLP.ERR_ATT_VALUES):(h=this.m_xml.charAt(s),SAXStrings.QUOTES.indexOf(h)==-1?this._setErr(XMLP.ERR_ATT_VALUES):(_=this.m_xml.indexOf(h,s+1))==-1||_>e?this._setErr(XMLP.ERR_ATT_VALUES):(o=this.m_xml.substring(r,i+1),a=this.m_xml.substring(s+1,_),o.indexOf("<")!=-1?this._setErr(XMLP.ERR_ATT_LT_NAME):a.indexOf("<")!=-1?this._setErr(XMLP.ERR_ATT_LT_VALUE):(a=SAXStrings.replace(a,null,null,"\n"," "),a=SAXStrings.replace(a,null,null,"\t"," "),iRet=this._replaceEntities(a),iRet==XMLP._ERROR?iRet:(a=this.m_cAlt,this._findAttributeIndex(o)!=-1?this._setErr(XMLP.ERR_ATT_DUP):(this._addAttribute(o,a),this.m_iP=_+2,XMLP._ATT))))))},XMLP.prototype._parseCDATA=function(t){var e=this.m_xml.indexOf("]]>",t);return e==-1?this._setErr(XMLP.ERR_CLOSE_CDATA):(this._setContent(XMLP._CONT_XML,t,e),this.m_iP=e+3,XMLP._CDATA)},XMLP.prototype._parseComment=function(t){var e=this.m_xml.indexOf("-->",t);return e==-1?this._setErr(XMLP.ERR_CLOSE_COMMENT):(this._setContent(XMLP._CONT_XML,t,e),this.m_iP=e+3,XMLP._COMMENT)},XMLP.prototype._parseDTD=function(t){var e,r,i,n;if((e=this.m_xml.indexOf(">",t))==-1)return this._setErr(XMLP.ERR_CLOSE_DTD);for(i=this.m_xml.indexOf("[",t),r=i!=-1&&i<e?"]>":">";;){if(e==n)return this._setErr(XMLP.ERR_INFINITELOOP);if(n=e,(e=this.m_xml.indexOf(r,t))==-1)return this._setErr(XMLP.ERR_CLOSE_DTD);if("]]>"!=this.m_xml.substring(e-1,e+2))break}return this.m_iP=e+r.length,XMLP._DTD},XMLP.prototype._parseElement=function(t){var e,r,i,n,s,_,h;if(r=e=this.m_xml.indexOf(">",t),e==-1)return this._setErr(XMLP.ERR_CLOSE_ELM);if("/"==this.m_xml.charAt(t)?(s=XMLP._ELM_E,t++):s=XMLP._ELM_B,"/"==this.m_xml.charAt(e-1)){if(s==XMLP._ELM_E)return this._setErr(XMLP.ERR_ELM_EMPTY);s=XMLP._ELM_EMP,r--}if(r=SAXStrings.lastIndexOfNonWhitespace(this.m_xml,t,r),e-t!=1&&SAXStrings.indexOfNonWhitespace(this.m_xml,t,r)!=t)return this._setErr(XMLP.ERR_ELM_NAME);if(this._clearAttributes(),(i=SAXStrings.indexOfWhitespace(this.m_xml,t,r))==-1)i=r+1;else for(this.m_iP=i;this.m_iP<r;){if(this.m_iP==h)return this._setErr(XMLP.ERR_INFINITELOOP);if(h=this.m_iP,(n=this._parseAttribute(this.m_iP,r))==XMLP._ERROR)return n}return _=this.m_xml.substring(t,i),_.indexOf("<")!=-1?this._setErr(XMLP.ERR_ELM_LT_NAME):(this.m_name=_,this.m_iP=e+1,s)},XMLP.prototype._parseEntity=function(t){var e=this.m_xml.indexOf(";",t);return e==-1?this._setErr(XMLP.ERR_CLOSE_ENTITY):(this.m_iP=e+1,this._replaceEntity(this.m_xml,t,e))},XMLP.prototype._parsePI=function(t){var e,r,i,n,s;return(e=this.m_xml.indexOf("?>",t))==-1?this._setErr(XMLP.ERR_CLOSE_PI):(r=SAXStrings.indexOfNonWhitespace(this.m_xml,t,e))==-1?this._setErr(XMLP.ERR_PI_TARGET):(i=SAXStrings.indexOfWhitespace(this.m_xml,r,e),i==-1&&(i=e),n=SAXStrings.indexOfNonWhitespace(this.m_xml,i,e),n==-1&&(n=e),s=SAXStrings.lastIndexOfNonWhitespace(this.m_xml,n,e),s==-1&&(s=e-1),this.m_name=this.m_xml.substring(r,i),this._setContent(XMLP._CONT_XML,n,s+1),this.m_iP=e+2,XMLP._PI)},XMLP.prototype._parseText=function(t){var e,r;return e=this.m_xml.indexOf("<",t),e==-1&&(e=this.m_xml.length),r=this.m_xml.indexOf("&",t),r!=-1&&r<=e&&(e=r),this._setContent(XMLP._CONT_XML,t,e),this.m_iP=e,XMLP._TEXT},XMLP.prototype._replaceEntities=function(t,e,r){if(SAXStrings.isEmpty(t))return"";e=e||0,r=r||t.length;var i,n,s="";for(i=t.indexOf("&",e),n=e;i>0&&i<r;){if(s+=t.substring(n,i),0==(n=t.indexOf(";",i)+1)||n>r)return this._setErr(XMLP.ERR_CLOSE_ENTITY);if(iRet=this._replaceEntity(t,i+1,n-1),iRet==XMLP._ERROR)return iRet;s+=this.m_cAlt,i=t.indexOf("&",n)}return n!=r&&(s+=t.substring(n,r)),this._setContent(XMLP._CONT_ALT,s),XMLP._ENTITY},XMLP.prototype._replaceEntity=function(t,e,r){if(SAXStrings.isEmpty(t))return-1;switch(e=e||0,r=r||t.length,t.substring(e,r)){case"amp":strEnt="&";break;case"lt":strEnt="<";break;case"gt":strEnt=">";break;case"apos":strEnt="'";break;case"quot":strEnt='"';break;default:if("#"!=t.charAt(e))return this._setErr(XMLP.ERR_ENTITY_UNKNOWN);strEnt=String.fromCharCode(parseInt(t.substring(e+1,r)))}return this._setContent(XMLP._CONT_ALT,strEnt),XMLP._ENTITY},XMLP.prototype._setContent=function(t){var e=arguments;XMLP._CONT_XML==t?(this.m_cAlt=null,this.m_cB=e[1],this.m_cE=e[2]):(this.m_cAlt=e[1],this.m_cB=0,this.m_cE=e[1].length),this.m_cSrc=t},XMLP.prototype._setErr=function(t){var e=XMLP._errs[t];return this.m_cAlt=e,this.m_cB=0,this.m_cE=e.length,this.m_cSrc=XMLP._CONT_ALT,XMLP._ERROR},SAXDriver=function(){this.m_hndDoc=null,this.m_hndErr=null,this.m_hndLex=null},SAXDriver.DOC_B=1,SAXDriver.DOC_E=2,SAXDriver.ELM_B=3,SAXDriver.ELM_E=4,SAXDriver.CHARS=5,SAXDriver.PI=6,SAXDriver.CD_B=7,SAXDriver.CD_E=8,SAXDriver.CMNT=9,SAXDriver.DTD_B=10,SAXDriver.DTD_E=11,SAXDriver.prototype.parse=function(t){var e=new XMLP(t);this.m_hndDoc&&this.m_hndDoc.setDocumentLocator&&this.m_hndDoc.setDocumentLocator(this),this.m_parser=e,this.m_bErr=!1,this.m_bErr||this._fireEvent(SAXDriver.DOC_B),this._parseLoop(),this.m_bErr||this._fireEvent(SAXDriver.DOC_E),this.m_xml=null,this.m_iP=0},SAXDriver.prototype.setDocumentHandler=function(t){this.m_hndDoc=t},SAXDriver.prototype.setErrorHandler=function(t){this.m_hndErr=t},SAXDriver.prototype.setLexicalHandler=function(t){this.m_hndLex=t},SAXDriver.prototype.getColumnNumber=function(){return this.m_parser.getColumnNumber()},SAXDriver.prototype.getLineNumber=function(){return this.m_parser.getLineNumber()},SAXDriver.prototype.getMessage=function(){return this.m_strErrMsg},SAXDriver.prototype.getPublicId=function(){return null},SAXDriver.prototype.getSystemId=function(){return null},SAXDriver.prototype.getLength=function(){return this.m_parser.getAttributeCount()},SAXDriver.prototype.getName=function(t){return this.m_parser.getAttributeName(t)},SAXDriver.prototype.getValue=function(t){return this.m_parser.getAttributeValue(t)},SAXDriver.prototype.getValueByName=function(t){return this.m_parser.getAttributeValueByName(t)},SAXDriver.prototype._fireError=function(t){this.m_strErrMsg=t,this.m_bErr=!0,this.m_hndErr&&this.m_hndErr.fatalError&&this.m_hndErr.fatalError(this)},SAXDriver.prototype._fireEvent=function(t){var e,r,i=arguments,n=i.length-1;this.m_bErr||(SAXDriver.DOC_B==t?(r="startDocument",e=this.m_hndDoc):SAXDriver.DOC_E==t?(r="endDocument",e=this.m_hndDoc):SAXDriver.ELM_B==t?(r="startElement",e=this.m_hndDoc):SAXDriver.ELM_E==t?(r="endElement",e=this.m_hndDoc):SAXDriver.CHARS==t?(r="characters",e=this.m_hndDoc):SAXDriver.PI==t?(r="processingInstruction",e=this.m_hndDoc):SAXDriver.CD_B==t?(r="startCDATA",e=this.m_hndLex):SAXDriver.CD_E==t?(r="endCDATA",e=this.m_hndLex):SAXDriver.CMNT==t&&(r="comment",e=this.m_hndLex),e&&e[r]&&(0==n?e[r]():1==n?e[r](i[1]):2==n?e[r](i[1],i[2]):3==n&&e[r](i[1],i[2],i[3])))},SAXDriver.prototype._parseLoop=function(t){var e,t;for(t=this.m_parser;!this.m_bErr;)if((e=t.next())==XMLP._ELM_B)this._fireEvent(SAXDriver.ELM_B,t.getName(),this);else if(e==XMLP._ELM_E)this._fireEvent(SAXDriver.ELM_E,t.getName());else if(e==XMLP._ELM_EMP)this._fireEvent(SAXDriver.ELM_B,t.getName(),this),this._fireEvent(SAXDriver.ELM_E,t.getName());else if(e==XMLP._TEXT)this._fireEvent(SAXDriver.CHARS,t.getContent(),t.getContentBegin(),t.getContentEnd()-t.getContentBegin());else if(e==XMLP._ENTITY)this._fireEvent(SAXDriver.CHARS,t.getContent(),t.getContentBegin(),t.getContentEnd()-t.getContentBegin());else if(e==XMLP._PI)this._fireEvent(SAXDriver.PI,t.getName(),t.getContent().substring(t.getContentBegin(),t.getContentEnd()));else if(e==XMLP._CDATA)this._fireEvent(SAXDriver.CD_B),this._fireEvent(SAXDriver.CHARS,t.getContent(),t.getContentBegin(),t.getContentEnd()-t.getContentBegin()),this._fireEvent(SAXDriver.CD_E);else if(e==XMLP._COMMENT)this._fireEvent(SAXDriver.CMNT,t.getContent(),t.getContentBegin(),t.getContentEnd()-t.getContentBegin());else if(e==XMLP._DTD);else if(e==XMLP._ERROR)this._fireError(t.getContent());else if(e==XMLP._NONE)return},SAXStrings=function(){},SAXStrings.WHITESPACE=" \t\n\r",SAXStrings.QUOTES="\"'",SAXStrings.getColumnNumber=function(t,e){if(SAXStrings.isEmpty(t))return-1;e=e||t.length;var r=t.substring(0,e).split("\n");r[r.length-1];return r.length--,e-r.join("\n").length},SAXStrings.getLineNumber=function(t,e){return SAXStrings.isEmpty(t)?-1:(e=e||t.length,t.substring(0,e).split("\n").length)},SAXStrings.indexOfNonWhitespace=function(t,e,r){if(SAXStrings.isEmpty(t))return-1;e=e||0,r=r||t.length;for(var i=e;i<r;i++)if(SAXStrings.WHITESPACE.indexOf(t.charAt(i))==-1)return i;return-1},SAXStrings.indexOfWhitespace=function(t,e,r){if(SAXStrings.isEmpty(t))return-1;e=e||0,r=r||t.length;for(var i=e;i<r;i++)if(SAXStrings.WHITESPACE.indexOf(t.charAt(i))!=-1)return i;return-1},SAXStrings.isEmpty=function(t){return null==t||0==t.length},SAXStrings.lastIndexOfNonWhitespace=function(t,e,r){if(SAXStrings.isEmpty(t))return-1;e=e||0,r=r||t.length;for(var i=r-1;i>=e;i--)if(SAXStrings.WHITESPACE.indexOf(t.charAt(i))==-1)return i;return-1},SAXStrings.replace=function(t,e,r,i,n){return SAXStrings.isEmpty(t)?"":(e=e||0,r=r||t.length,t.substring(e,r).split(i).join(n))},Stack=function(){this.m_arr=new Array},Stack.prototype.clear=function(){this.m_arr=new Array},Stack.prototype.count=function(){return this.m_arr.length},Stack.prototype.destroy=function(){this.m_arr=null},Stack.prototype.peek=function(){return 0==this.m_arr.length?null:this.m_arr[this.m_arr.length-1]},Stack.prototype.pop=function(){if(0==this.m_arr.length)return null;var t=this.m_arr[this.m_arr.length-1];return this.m_arr.length--,t},Stack.prototype.push=function(t){this.m_arr[this.m_arr.length]=t};var batchSize=100,parser=new SAXDriver;self.onmessage=function(t){var e=new SAXEventHandler(batchSize);parser.setDocumentHandler(e),parser.setErrorHandler(e),parser.parse(t.data)};
